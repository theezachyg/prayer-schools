<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>21 Days of Prayer 2025 - Map Export</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.8.5/d3.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/3.0.2/topojson.min.js"></script>
    <style>
      body {
        margin: 0;
        padding: 0;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, Ubuntu,
          sans-serif;
        background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
        overflow: hidden;
      }

      #map-container {
        width: 100vw;
        height: 100vh;
        position: relative;
        display: flex;
        align-items: center;
        justify-content: center;
      }

      #canvas {
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        border-radius: 8px;
      }

      #title {
        position: absolute;
        top: 40px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        z-index: 1000;
        pointer-events: none;
      }

      #title h1 {
        margin: 0;
        font-size: 48px;
        font-weight: 700;
        text-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        letter-spacing: -1px;
      }

      #title p {
        margin: 8px 0 0 0;
        font-size: 24px;
        font-weight: 300;
        opacity: 0.95;
        text-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
      }

      #stats {
        position: absolute;
        bottom: 40px;
        left: 50%;
        transform: translateX(-50%);
        color: white;
        text-align: center;
        z-index: 1000;
        background: rgba(0, 0, 0, 0.3);
        padding: 16px 32px;
        border-radius: 8px;
        backdrop-filter: blur(10px);
        pointer-events: none;
      }

      #stats span {
        font-size: 36px;
        font-weight: 700;
        color: #ffd700;
        text-shadow: 0 2px 8px rgba(255, 215, 0, 0.3);
      }

      .button-container {
        position: absolute;
        top: 40px;
        right: 40px;
        display: flex;
        gap: 12px;
        z-index: 1000;
      }

      .action-btn {
        padding: 12px 24px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        transition: all 0.3s ease;
      }

      .action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
      }

      .action-btn:disabled {
        background: #6b7280;
        cursor: not-allowed;
        opacity: 0.7;
      }

      #loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        text-align: center;
        z-index: 2000;
        background: rgba(0, 0, 0, 0.8);
        padding: 40px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
      }

      #loading h2 {
        color: white;
        margin-bottom: 20px;
        font-size: 28px;
      }

      #loading p {
        color: rgba(255, 255, 255, 0.8);
        font-size: 18px;
        margin: 10px 0;
      }

      .spinner {
        width: 50px;
        height: 50px;
        border: 4px solid rgba(255, 255, 255, 0.2);
        border-top-color: #667eea;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 20px auto;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }

      .error {
        color: #ff6b6b;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <div id="map-container">
      <div id="title">
        <h1>21 DAYS OF PRAYER</h1>
        <p>FOR OUR NATION'S SCHOOLS</p>
      </div>

      <div id="loading">
        <h2>Loading Prayer Map</h2>
        <div class="spinner"></div>
        <p>Fetching school data from Google Sheets...</p>
        <div class="error"></div>
      </div>

      <canvas
        id="canvas"
        width="3840"
        height="2160"
        style="display: none"
      ></canvas>

      <div id="stats" style="display: none">
        <span id="school-count">0</span> Schools Adopted
      </div>

      <div class="button-container" style="display: none">
        <button class="action-btn" onclick="exportMap()">
          Export High Resolution Image
        </button>
        <button class="action-btn" onclick="reloadData()">Refresh Data</button>
      </div>
    </div>

    <!-- Load configuration -->
    <script src="/config.js"></script>

    <script>
      // Get config from environment variables
      const config = window.ENV || {};

      // Debug logging
      console.log("Environment config loaded");
      console.log("Maps API Key present:", !!config.GOOGLE_MAPS_API_KEY);
      console.log("Sheet ID present:", !!config.SHEET_ID);

      // Check for required configuration
      if (!config.GOOGLE_MAPS_API_KEY || !config.SHEET_ID) {
        console.error("Missing required configuration");
        document.getElementById("loading").innerHTML = `
				<h2 style="color: #ff6b6b;">Configuration Error</h2>
				<p style="color: rgba(255,255,255,0.8);">
					Missing API configuration. Please ensure environment variables are set.
				</p>
			`;
      }

      // Google Sheets API URL
      const SHEETS_API_URL =
        config.SHEET_ID && config.GOOGLE_MAPS_API_KEY
          ? `https://sheets.googleapis.com/v4/spreadsheets/${config.SHEET_ID}/values/Sheet1?key=${config.GOOGLE_MAPS_API_KEY}`
          : null;

      const width = 3840;
      const height = 2160;
      const canvas = document.getElementById("canvas");
      const ctx = canvas.getContext("2d");

      // Set canvas display size (scaled for viewport)
      const scale = Math.min(
        (window.innerWidth / width) * 0.9,
        (window.innerHeight / height) * 0.9,
      );
      canvas.style.width = width * scale + "px";
      canvas.style.height = height * scale + "px";

      // Map styling
      const bgColor = "#0a0e27";
      const landColor = "#1a2f4a";
      const strokeColor = "#2a4a7a";
      const pointColor = "#FFD700";
      const glowColor = "#FFA500";

      // Load data from Google Sheets
      async function loadSchoolData() {
        console.log("Loading school data from Google Sheets...");

        if (!SHEETS_API_URL) {
          showError("Configuration not loaded. Please refresh the page.");
          return;
        }

        try {
          const response = await fetch(SHEETS_API_URL);
          if (!response.ok) {
            // If 400 error, might be API key issue
            if (response.status === 400) {
              throw new Error(
                "Invalid API configuration. Please check API key and Sheet ID.",
              );
            }
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();
          console.log("Data loaded successfully");

          if (data.values && data.values.length > 1) {
            await processSheetData(data.values);
          } else {
            throw new Error("No data found in sheet");
          }
        } catch (error) {
          showError("Error loading data: " + error.message);
          console.error("Error details:", error);
        }
      }

      async function processSheetData(rows) {
        try {
          console.log(`Processing ${rows.length - 1} rows of data...`);

          // Skip header row
          const dataRows = rows.slice(1);
          const schools = [];

          // Process each row - columns match your existing site
          dataRows.forEach((row, index) => {
            const lat = parseFloat(row[7]); // Latitude column H
            const lng = parseFloat(row[8]); // Longitude column I
            const schoolName = row[4]; // School Name
            const schoolAddress = row[5]; // School Address

            if (!isNaN(lat) && !isNaN(lng) && lat && lng) {
              schools.push({
                name: schoolName,
                address: schoolAddress,
                latitude: lat,
                longitude: lng,
              });
            }
          });

          console.log(`Found ${schools.length} schools with valid coordinates`);

          if (schools.length === 0) {
            throw new Error("No schools with valid coordinates found");
          }

          // Load US topology
          const us = await d3.json(
            "https://cdn.jsdelivr.net/npm/us-atlas@3/states-10m.json",
          );

          // Filter for US schools (including Alaska and Hawaii)
          const usSchools = schools.filter((d) => {
            // Continental US
            if (
              d.latitude > 24 &&
              d.latitude < 50 &&
              d.longitude > -125 &&
              d.longitude < -66
            )
              return true;
            // Alaska
            if (
              d.latitude > 51 &&
              d.latitude < 72 &&
              (d.longitude < -130 || d.longitude > 170)
            )
              return true;
            // Hawaii
            if (
              d.latitude > 18 &&
              d.latitude < 23 &&
              d.longitude > -161 &&
              d.longitude < -154
            )
              return true;
            return false;
          });

          console.log(
            `${usSchools.length} schools in US (including Alaska and Hawaii)`,
          );

          // Hide loading and show canvas
          document.getElementById("loading").style.display = "none";
          canvas.style.display = "block";
          document.getElementById("stats").style.display = "block";
          document.querySelector(".button-container").style.display = "flex";

          // Update count
          document.getElementById("school-count").textContent =
            usSchools.length.toLocaleString();

          // Setup projection - Albers USA for beautiful US visualization
          const projection = d3
            .geoAlbersUsa()
            .scale(4000)
            .translate([width / 2, height / 2]);

          const path = d3.geoPath().projection(projection).context(ctx);

          // Clear and set background
          ctx.fillStyle = bgColor;
          ctx.fillRect(0, 0, width, height);

          // Draw land masses
          ctx.fillStyle = landColor;
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 2;

          // Draw states
          const land = topojson.feature(us, us.objects.states);
          ctx.beginPath();
          path(land);
          ctx.fill();
          ctx.stroke();

          // Draw state borders
          ctx.strokeStyle = strokeColor;
          ctx.lineWidth = 1;
          ctx.globalAlpha = 0.5;
          ctx.beginPath();
          path(topojson.mesh(us, us.objects.states, (a, b) => a !== b));
          ctx.stroke();
          ctx.globalAlpha = 1;

          // Create point density map for glow effect
          const pointDensity = {};
          usSchools.forEach((school) => {
            const coords = projection([school.longitude, school.latitude]);
            if (coords) {
              const key = `${Math.round(coords[0] / 20)}_${Math.round(coords[1] / 20)}`;
              pointDensity[key] = (pointDensity[key] || 0) + 1;
            }
          });

          // Draw schools with glow effect
          ctx.shadowBlur = 0;

          // First pass - draw glow for dense areas
          ctx.globalCompositeOperation = "screen";
          ctx.globalAlpha = 0.15;

          usSchools.forEach((school) => {
            const coords = projection([school.longitude, school.latitude]);
            if (coords) {
              const key = `${Math.round(coords[0] / 20)}_${Math.round(coords[1] / 20)}`;
              const density = pointDensity[key] || 1;

              if (density > 3) {
                ctx.beginPath();
                ctx.fillStyle = glowColor;
                ctx.arc(
                  coords[0],
                  coords[1],
                  Math.min(density * 3, 30),
                  0,
                  2 * Math.PI,
                );
                ctx.fill();
              }
            }
          });

          // Second pass - draw actual points
          ctx.globalCompositeOperation = "source-over";
          ctx.globalAlpha = 1;

          usSchools.forEach((school) => {
            const coords = projection([school.longitude, school.latitude]);
            if (coords) {
              // Draw point
              ctx.beginPath();
              ctx.fillStyle = pointColor;
              ctx.arc(coords[0], coords[1], 3, 0, 2 * Math.PI);
              ctx.fill();

              // Add subtle glow
              ctx.globalAlpha = 0.3;
              ctx.beginPath();
              ctx.fillStyle = glowColor;
              ctx.arc(coords[0], coords[1], 6, 0, 2 * Math.PI);
              ctx.fill();
              ctx.globalAlpha = 1;
            }
          });

          // Add decorative border
          ctx.strokeStyle = "rgba(255,255,255,0.1)";
          ctx.lineWidth = 4;
          ctx.strokeRect(2, 2, width - 4, height - 4);

          // Add timestamp
          const now = new Date();
          ctx.fillStyle = "rgba(255,255,255,0.5)";
          ctx.font = "14px sans-serif";
          ctx.textAlign = "right";
          ctx.fillText(
            `Generated: ${now.toLocaleString()}`,
            width - 20,
            height - 20,
          );

          console.log("Map rendered successfully!");
        } catch (error) {
          showError("Error processing data: " + error.message);
          console.error(error);
        }
      }

      function showError(message) {
        const loadingEl = document.getElementById("loading");
        loadingEl.querySelector(".spinner").style.display = "none";
        loadingEl.querySelector("p").style.display = "none";
        const errorEl = loadingEl.querySelector(".error");
        errorEl.textContent = message;
        errorEl.style.display = "block";
      }

      function exportMap() {
        const exportBtn = event.target;
        exportBtn.disabled = true;
        exportBtn.textContent = "Generating...";

        canvas.toBlob(
          (blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url;
            const date = new Date().toISOString().split("T")[0];
            a.download = `21_Days_Prayer_Schools_Map_4K_${date}.png`;
            a.click();
            URL.revokeObjectURL(url);

            exportBtn.disabled = false;
            exportBtn.textContent = "Export 4K Image";
          },
          "image/png",
          1.0,
        );
      }

      function reloadData() {
        document.getElementById("loading").style.display = "block";
        document
          .getElementById("loading")
          .querySelector(".spinner").style.display = "block";
        document.getElementById("loading").querySelector("p").style.display =
          "block";
        document.getElementById("loading").querySelector("p").textContent =
          "Refreshing data...";
        document
          .getElementById("loading")
          .querySelector(".error").style.display = "none";
        canvas.style.display = "none";
        document.getElementById("stats").style.display = "none";
        document.querySelector(".button-container").style.display = "none";

        loadSchoolData();
      }

      // Initialize on page load
      window.addEventListener("load", () => {
        // Wait a moment for config to load
        setTimeout(() => {
          if (config.GOOGLE_MAPS_API_KEY && config.SHEET_ID) {
            loadSchoolData();
          } else {
            console.error("Configuration not available");
            showError(
              "Configuration not loaded. Please ensure you're accessing this from the deployed site.",
            );
          }
        }, 100);
      });
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Prayer Map API Debugger</title>
    <style>
      body {
        margin: 0;
        padding: 20px;
        font-family:
          -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
        background: #f5f5f5;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }

      h1 {
        color: #113a51;
        margin-bottom: 30px;
      }

      .test-section {
        margin: 20px 0;
        padding: 20px;
        background: #f9f9f9;
        border-radius: 5px;
        border-left: 4px solid #36b7ff;
      }

      .test-title {
        font-weight: bold;
        color: #113a51;
        margin-bottom: 10px;
      }

      .result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 3px;
        font-family: "Courier New", monospace;
        font-size: 12px;
        word-wrap: break-word;
      }

      .success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .info {
        background: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }

      .warning {
        background: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }

      button {
        background: #36b7ff;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        margin-top: 10px;
      }

      button:hover {
        background: #2a9fdd;
      }

      button:disabled {
        background: #ccc;
        cursor: not-allowed;
      }

      .spinner {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid #ffffff;
        border-top-color: transparent;
        border-radius: 50%;
        animation: spin 0.8s linear infinite;
        margin-right: 8px;
      }

      @keyframes spin {
        to {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Prayer Map API Debugger</h1>

      <div class="test-section">
        <div class="test-title">1. Configuration Check</div>
        <div id="config-result" class="result info">
          Checking configuration...
        </div>
      </div>

      <div class="test-section">
        <div class="test-title">2. API URL Construction</div>
        <div id="url-result" class="result info">
          Waiting for configuration...
        </div>
      </div>

      <div class="test-section">
        <div class="test-title">3. Direct API Test (Manual)</div>
        <button id="test-api-btn" onclick="testAPI()" disabled>
          Test API Connection
        </button>
        <div id="api-result" class="result info">
          Click button to test API connection
        </div>
      </div>

      <div class="test-section">
        <div class="test-title">4. Alternative Method Test</div>
        <button id="test-alt-btn" onclick="testAlternative()" disabled>
          Test Alternative Method
        </button>
        <div id="alt-result" class="result info">
          Click button to test alternative method
        </div>
      </div>

      <div class="test-section">
        <div class="test-title">5. Manual Configuration Entry</div>
        <p>If the above tests fail, try entering the values manually:</p>
        <div style="margin: 10px 0">
          <label>Sheet ID: </label>
          <input
            type="text"
            id="manual-sheet-id"
            placeholder="e.g., 1MBUMqHgTTOjRWMdTE0f0E33i0fQVz78p6TQvhLAHKmE"
            style="width: 100%; padding: 5px; margin-top: 5px"
          />
        </div>
        <div style="margin: 10px 0">
          <label>API Key: </label>
          <input
            type="text"
            id="manual-api-key"
            placeholder="Your Google API Key"
            style="width: 100%; padding: 5px; margin-top: 5px"
          />
        </div>
        <button onclick="testManual()">Test Manual Configuration</button>
        <div id="manual-result" class="result info">
          Enter values above and click test
        </div>
      </div>
    </div>

    <!-- Load configuration -->
    <script src="/config.js"></script>

    <script>
      let globalConfig = null;
      let apiUrl = null;

      // Check configuration on load
      window.addEventListener("load", () => {
        setTimeout(checkConfig, 100);
      });

      function checkConfig() {
        const configResult = document.getElementById("config-result");
        const urlResult = document.getElementById("url-result");

        try {
          // Check if ENV exists
          if (typeof window.ENV !== "undefined") {
            globalConfig = window.ENV;

            let configStatus = [];

            // Check each required field
            if (globalConfig.GOOGLE_MAPS_API_KEY) {
              configStatus.push(
                `✓ API Key: ${globalConfig.GOOGLE_MAPS_API_KEY.substring(0, 10)}...`,
              );
            } else {
              configStatus.push("✗ API Key: NOT FOUND");
            }

            if (globalConfig.SHEET_ID) {
              configStatus.push(`✓ Sheet ID: ${globalConfig.SHEET_ID}`);
            } else {
              configStatus.push("✗ Sheet ID: NOT FOUND");
            }

            if (globalConfig.GOOGLE_SHEETS_WEB_APP_URL) {
              configStatus.push(
                `✓ Web App URL: ${globalConfig.GOOGLE_SHEETS_WEB_APP_URL.substring(0, 30)}...`,
              );
            }

            configResult.className =
              "result " +
              (globalConfig.GOOGLE_MAPS_API_KEY && globalConfig.SHEET_ID
                ? "success"
                : "error");
            configResult.innerHTML = configStatus.join("<br>");

            // Construct API URL
            if (globalConfig.GOOGLE_MAPS_API_KEY && globalConfig.SHEET_ID) {
              apiUrl = `https://sheets.googleapis.com/v4/spreadsheets/${globalConfig.SHEET_ID}/values/Sheet1?key=${globalConfig.GOOGLE_MAPS_API_KEY}`;
              urlResult.className = "result success";
              urlResult.innerHTML = `API URL constructed:<br>${apiUrl.substring(0, 100)}...`;

              // Enable test buttons
              document.getElementById("test-api-btn").disabled = false;
              document.getElementById("test-alt-btn").disabled = false;
            } else {
              urlResult.className = "result error";
              urlResult.innerHTML =
                "Cannot construct API URL - missing configuration";
            }
          } else {
            configResult.className = "result error";
            configResult.innerHTML =
              "window.ENV not found - config.js may not be loaded";
            urlResult.className = "result error";
            urlResult.innerHTML = "Cannot proceed without configuration";
          }
        } catch (error) {
          configResult.className = "result error";
          configResult.innerHTML = `Error checking configuration: ${error.message}`;
        }
      }

      async function testAPI() {
        const btn = document.getElementById("test-api-btn");
        const result = document.getElementById("api-result");

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Testing...';
        result.className = "result info";
        result.innerHTML = "Sending API request...";

        try {
          console.log("Testing API with URL:", apiUrl);

          const response = await fetch(apiUrl);
          const responseText = await response.text();

          console.log("Response status:", response.status);
          console.log("Response headers:", response.headers);

          if (response.ok) {
            const data = JSON.parse(responseText);
            result.className = "result success";
            result.innerHTML = `✓ API Connection Successful!<br>
						Status: ${response.status}<br>
						Rows found: ${data.values ? data.values.length : 0}<br>
						First row: ${data.values && data.values[0] ? data.values[0].slice(0, 3).join(", ") + "..." : "No data"}`;
          } else {
            // Try to parse error message
            let errorMsg = responseText;
            try {
              const errorData = JSON.parse(responseText);
              errorMsg = errorData.error
                ? errorData.error.message
                : responseText;
            } catch (e) {}

            result.className = "result error";
            result.innerHTML = `✗ API Error ${response.status}<br>
						Message: ${errorMsg}<br>
						<br>Possible causes:<br>
						- API key doesn't have Sheets API enabled<br>
						- Sheet ID is incorrect<br>
						- Sheet is not publicly readable`;
          }
        } catch (error) {
          console.error("Fetch error:", error);
          result.className = "result error";
          result.innerHTML = `✗ Network Error: ${error.message}<br>
					This might be a CORS issue if testing locally`;
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Test API Connection";
        }
      }

      async function testAlternative() {
        const btn = document.getElementById("test-alt-btn");
        const result = document.getElementById("alt-result");

        if (!globalConfig || !globalConfig.SHEET_ID) {
          result.className = "result error";
          result.innerHTML = "Missing configuration";
          return;
        }

        btn.disabled = true;
        btn.innerHTML = '<span class="spinner"></span>Testing...';

        // Test with public sheet access (no API key)
        const publicUrl = `https://docs.google.com/spreadsheets/d/${globalConfig.SHEET_ID}/gviz/tq?tqx=out:json`;

        try {
          console.log("Testing public access:", publicUrl);

          const response = await fetch(publicUrl);
          const text = await response.text();

          if (response.ok) {
            result.className = "result success";
            result.innerHTML = `✓ Sheet is publicly accessible<br>
						Status: ${response.status}<br>
						Response length: ${text.length} characters<br>
						<br>Note: The sheet can be accessed publicly`;
          } else {
            result.className = "result warning";
            result.innerHTML = `Sheet may not be publicly accessible<br>
						Status: ${response.status}<br>
						This might require different permissions`;
          }
        } catch (error) {
          result.className = "result error";
          result.innerHTML = `Network error: ${error.message}`;
        } finally {
          btn.disabled = false;
          btn.innerHTML = "Test Alternative Method";
        }
      }

      async function testManual() {
        const sheetId = document.getElementById("manual-sheet-id").value.trim();
        const apiKey = document.getElementById("manual-api-key").value.trim();
        const result = document.getElementById("manual-result");

        if (!sheetId || !apiKey) {
          result.className = "result error";
          result.innerHTML = "Please enter both Sheet ID and API Key";
          return;
        }

        const manualUrl = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/Sheet1?key=${apiKey}`;

        result.className = "result info";
        result.innerHTML = `Testing URL: ${manualUrl.substring(0, 80)}...`;

        try {
          const response = await fetch(manualUrl);
          const data = await response.json();

          if (response.ok) {
            result.className = "result success";
            result.innerHTML = `✓ Success! The configuration works.<br>
						Rows found: ${data.values ? data.values.length : 0}<br>
						<br>Use these values in your environment configuration:<br>
						SHEET_ID: ${sheetId}<br>
						GOOGLE_MAPS_API_KEY: ${apiKey}`;
          } else {
            result.className = "result error";
            result.innerHTML = `✗ Error ${response.status}: ${data.error ? data.error.message : "Unknown error"}`;
          }
        } catch (error) {
          result.className = "result error";
          result.innerHTML = `✗ Network Error: ${error.message}`;
        }
      }
    </script>
  </body>
</html>
